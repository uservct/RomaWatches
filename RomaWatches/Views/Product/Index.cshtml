@model List<RomaWatches.Models.Product>
@using Microsoft.AspNetCore.Identity
@using RomaWatches.Models
@inject SignInManager<ApplicationUser> SignInManager
@{
    ViewData["Title"] = "ROMA WATCHES - Cửa Hàng";
    Layout = null;
}
<!DOCTYPE html>
<html class="dark" lang="vi">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>@ViewData["Title"]</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700;900&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ecb613",
                        "background-light": "#f8f8f6",
                        "background-dark": "#221d10",
                    },
                    fontFamily: {
                        "display": ["Noto Serif", "Noto Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
    <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        @await Html.PartialAsync("_Header")
        <div class="h-[72px]"></div>
        <main class="w-full max-w-screen-2xl mx-auto px-4 sm:px-8 lg:px-10 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <aside class="lg:col-span-1 lg:sticky lg:top-24 h-fit">
                    <div class="flex h-full min-h-[700px] flex-col justify-between bg-transparent p-4 rounded-lg border border-neutral-200/50 dark:border-white/10">
                        <div class="flex flex-col gap-6">
                            <div class="flex flex-col">
                                <h1 class="text-neutral-800 dark:text-white text-lg font-medium leading-normal">Bộ lọc</h1>
                                <p class="text-neutral-500 dark:text-[#b9b29d] text-sm font-normal leading-normal">Tinh chỉnh tìm kiếm của bạn</p>
                            </div>
                            <div class="flex flex-col gap-3">
                                <!-- Thương hiệu Filter -->
                                <div class="filter-section">
                                    <button onclick="toggleFilter(this)" class="flex items-center justify-between gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-[#393528] w-full">
                                        <div class="flex items-center gap-3">
                                            <span class="material-symbols-outlined text-primary dark:text-white">sell</span>
                                            <p class="text-neutral-800 dark:text-white text-sm font-medium leading-normal">Thương hiệu</p>
                                        </div>
                                        <span class="material-symbols-outlined text-neutral-600 dark:text-white text-xl filter-icon">expand_less</span>
                                    </button>
                                    <div class="filter-content mt-2 px-3 space-y-2">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="brand" value="rolex">
                                            <span class="text-neutral-800 dark:text-white text-sm">Rolex</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="brand" value="omega">
                                            <span class="text-neutral-800 dark:text-white text-sm">Omega</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="brand" value="patek philippe">
                                            <span class="text-neutral-800 dark:text-white text-sm">Patek Philippe</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="brand" value="audemars piguet">
                                            <span class="text-neutral-800 dark:text-white text-sm">Audemars Piguet</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="brand" value="cartier">
                                            <span class="text-neutral-800 dark:text-white text-sm">Cartier</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="brand" value="hublot">
                                            <span class="text-neutral-800 dark:text-white text-sm">Hublot</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Giá bán Filter -->
                                <div class="filter-section">
                                    <button onclick="toggleFilter(this)" class="flex items-center justify-between gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 w-full transition-colors">
                                        <div class="flex items-center gap-3">
                                            <span class="material-symbols-outlined text-neutral-600 dark:text-white">attach_money</span>
                                            <p class="text-neutral-800 dark:text-white text-sm font-medium leading-normal">Giá bán</p>
                                        </div>
                                        <span class="material-symbols-outlined text-neutral-600 dark:text-white text-xl filter-icon">expand_more</span>
                                    </button>
                                    <div class="filter-content mt-2 px-3 space-y-2 hidden">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="price" value="2-5">
                                            <span class="text-neutral-800 dark:text-white text-sm">Từ 2-5 triệu</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="price" value="5-10">
                                            <span class="text-neutral-800 dark:text-white text-sm">Từ 5-10 triệu</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="price" value="10-20">
                                            <span class="text-neutral-800 dark:text-white text-sm">Từ 10-20 triệu</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="price" value="20-50">
                                            <span class="text-neutral-800 dark:text-white text-sm">Từ 20-50 triệu</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="price" value="50+">
                                            <span class="text-neutral-800 dark:text-white text-sm">Trên 50 triệu</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Giới tính Filter -->
                                <div class="filter-section">
                                    <button onclick="toggleFilter(this)" class="flex items-center justify-between gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 w-full transition-colors">
                                        <div class="flex items-center gap-3">
                                            <span class="material-symbols-outlined text-neutral-600 dark:text-white">group</span>
                                            <p class="text-neutral-800 dark:text-white text-sm font-medium leading-normal">Giới tính</p>
                                        </div>
                                        <span class="material-symbols-outlined text-neutral-600 dark:text-white text-xl filter-icon">expand_more</span>
                                    </button>
                                    <div class="filter-content mt-2 px-3 space-y-2 hidden">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="gender" value="nam">
                                            <span class="text-neutral-800 dark:text-white text-sm">Nam</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="gender" value="nữ">
                                            <span class="text-neutral-800 dark:text-white text-sm">Nữ</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="gender" value="đôi">
                                            <span class="text-neutral-800 dark:text-white text-sm">Đồng hồ đôi</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Bộ máy Filter -->
                                <div class="filter-section">
                                    <button onclick="toggleFilter(this)" class="flex items-center justify-between gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 w-full transition-colors">
                                        <div class="flex items-center gap-3">
                                            <span class="material-symbols-outlined text-neutral-600 dark:text-white">watch</span>
                                            <p class="text-neutral-800 dark:text-white text-sm font-medium leading-normal">Bộ máy</p>
                                        </div>
                                        <span class="material-symbols-outlined text-neutral-600 dark:text-white text-xl filter-icon">expand_more</span>
                                    </button>
                                    <div class="filter-content mt-2 px-3 space-y-2 hidden">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="movement" value="đồng hồ cơ">
                                            <span class="text-neutral-800 dark:text-white text-sm">Đồng hồ cơ</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="movement" value="đồng hồ điện tử">
                                            <span class="text-neutral-800 dark:text-white text-sm">Đồng hồ điện tử</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Loại dây Filter -->
                                <div class="filter-section">
                                    <button onclick="toggleFilter(this)" class="flex items-center justify-between gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 w-full transition-colors">
                                        <div class="flex items-center gap-3">
                                            <span class="material-symbols-outlined text-neutral-600 dark:text-white">link</span>
                                            <p class="text-neutral-800 dark:text-white text-sm font-medium leading-normal">Loại dây</p>
                                        </div>
                                        <span class="material-symbols-outlined text-neutral-600 dark:text-white text-xl filter-icon">expand_more</span>
                                    </button>
                                    <div class="filter-content mt-2 px-3 space-y-2 hidden">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="strap" value="dây da">
                                            <span class="text-neutral-800 dark:text-white text-sm">Dây da</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="strap" value="dây dù">
                                            <span class="text-neutral-800 dark:text-white text-sm">Dây dù</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="strap" value="dây silicone">
                                            <span class="text-neutral-800 dark:text-white text-sm">Dây silicone</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="strap" value="thép không rỉ">
                                            <span class="text-neutral-800 dark:text-white text-sm">Thép không rỉ</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Kháng nước Filter -->
                                <div class="filter-section">
                                    <button onclick="toggleFilter(this)" class="flex items-center justify-between gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 w-full transition-colors">
                                        <div class="flex items-center gap-3">
                                            <span class="material-symbols-outlined text-neutral-600 dark:text-white">water_drop</span>
                                            <p class="text-neutral-800 dark:text-white text-sm font-medium leading-normal">Kháng nước</p>
                                        </div>
                                        <span class="material-symbols-outlined text-neutral-600 dark:text-white text-xl filter-icon">expand_more</span>
                                    </button>
                                    <div class="filter-content mt-2 px-3 space-y-2 hidden">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="waterproof" value="3">
                                            <span class="text-neutral-800 dark:text-white text-sm">3 ATM</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="waterproof" value="5">
                                            <span class="text-neutral-800 dark:text-white text-sm">5 ATM</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="waterproof" value="10">
                                            <span class="text-neutral-800 dark:text-white text-sm">10 ATM</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" name="waterproof" value="20">
                                            <span class="text-neutral-800 dark:text-white text-sm">20 ATM</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-4 mt-8">
                            <button id="clearAllFilters" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 gap-2 hover:bg-primary/10 transition-colors">
                                <span class="material-symbols-outlined text-neutral-600 dark:text-white text-xl">close</span>
                                <p class="text-neutral-800 dark:text-white text-sm font-medium leading-normal">Xóa tất cả</p>
                            </button>
                        </div>
                    </div>
                </aside>
                <div class="lg:col-span-3">
                    <div class="flex flex-col gap-4 mb-6">
                        <div class="flex flex-wrap gap-2">
                            <a class="text-neutral-500 dark:text-[#b9b29d] text-sm font-medium leading-normal" asp-controller="Home" asp-action="Index">Trang chủ</a>
                            <span class="text-neutral-500 dark:text-[#b9b29d] text-sm font-medium leading-normal">/</span>
                            <a class="text-neutral-500 dark:text-[#b9b29d] text-sm font-medium leading-normal" asp-controller="Product" asp-action="Index">Đồng hồ</a>
                            <span class="text-neutral-500 dark:text-[#b9b29d] text-sm font-medium leading-normal">/</span>
                            <span class="text-neutral-800 dark:text-white text-sm font-medium leading-normal">Tất cả</span>
                        </div>
                        <p class="text-neutral-800 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em] font-display">Đồng Hồ Sang Trọng</p>
                        <p class="text-neutral-500 dark:text-[#b9b29d] text-base font-normal leading-normal">Khám phá bộ sưu tập đồng hồ được tuyển chọn của chúng tôi</p>
                    </div>
                    <div class="flex justify-end mb-6">
                        <div class="flex gap-3 pb-2">
                            <div class="relative" style="z-index: 50;">
                                <button id="sortDropdownBtn" onclick="toggleSortDropdown(event)" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-neutral-700 dark:bg-neutral-800 pl-4 pr-2 hover:bg-neutral-600 dark:hover:bg-neutral-700 transition-colors">
                                    <p id="sortSelectedText" class="text-white text-sm font-medium leading-normal">Sắp xếp mặc định</p>
                                    <span id="sortDropdownIcon" class="material-symbols-outlined text-white text-sm">expand_more</span>
                                </button>
                                <div id="sortDropdownMenu" class="absolute right-0 mt-2 w-72 bg-white dark:bg-neutral-800 rounded-lg shadow-lg border border-neutral-200 dark:border-neutral-700 hidden z-50" style="display: none;">
                                    <div class="flex flex-col">
                                        <button onclick="selectSortOption('default', 'Sắp xếp mặc định', event)" class="w-full text-left px-4 py-2.5 text-sm font-medium text-white bg-blue-600 dark:bg-blue-500 hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors sort-option" data-value="default">
                                            Sắp xếp mặc định
                                        </button>
                                        <button onclick="selectSortOption('price-low', 'Sắp xếp theo giá: thấp đến cao', event)" class="w-full text-left px-4 py-2.5 text-sm font-medium text-neutral-800 dark:text-white hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors sort-option" data-value="price-low">
                                            Sắp xếp theo giá: thấp đến cao
                                        </button>
                                        <button onclick="selectSortOption('price-high', 'Sắp xếp theo giá: cao đến thấp', event)" class="w-full text-left px-4 py-2.5 text-sm font-medium text-neutral-800 dark:text-white hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors sort-option" data-value="price-high">
                                            Sắp xếp theo giá: cao đến thấp
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-8">
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var product in Model)
                            {
                                <div class="flex flex-col group">
                                    <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="flex flex-col">
                                        <div class="overflow-hidden rounded-lg bg-neutral-200/50 dark:bg-[#393528]/50">
                                            <img alt="@product.Name" 
                                                 class="w-full h-80 object-cover group-hover:scale-105 transition-transform duration-300" 
                                                 src="@(string.IsNullOrEmpty(product.ImageUrl) ? "https://images.unsplash.com/photo-1523275335684-37898b6baf30" : product.ImageUrl)" />
                                        </div>
                                        <div class="flex flex-col gap-1 mt-4">
                                            <h3 class="text-neutral-800 dark:text-white text-lg font-bold">@product.Brand.ToUpper()</h3>
                                            <p class="text-neutral-600 dark:text-[#b9b29d] text-sm">@product.Name</p>
                                            <p class="text-neutral-800 dark:text-white font-semibold mt-1">@product.Price.ToString("N0") ₫</p>
                                        </div>
                                    </a>
                                    <div class="flex gap-2 mt-3">
                                        <button onclick="addToCart(@product.Id, event)" class="flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-neutral-700 dark:bg-neutral-600 hover:bg-neutral-800 dark:hover:bg-neutral-700 text-white font-medium transition-colors">
                                            <span class="material-symbols-outlined text-base">add_shopping_cart</span>
                                            <span class="text-sm">Giỏ hàng</span>
                                        </button>
                                        <button onclick="buyNow(@product.Id, event)" class="flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-primary hover:bg-primary/90 text-neutral-900 font-semibold transition-colors shadow-sm">
                                            <span class="material-symbols-outlined text-base">shopping_bag</span>
                                            <span class="text-sm">Mua ngay</span>
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="col-span-full text-center py-12">
                                <p class="text-neutral-600 dark:text-[#b9b29d] text-lg">Không tìm thấy sản phẩm nào</p>
                            </div>
                        }
                    </div>
                    <nav aria-label="Pagination" class="flex items-center justify-center mt-12">
                        <a class="relative inline-flex items-center rounded-l-md px-2 py-2 text-neutral-500 dark:text-neutral-400 ring-1 ring-inset ring-neutral-300 dark:ring-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-800 focus:z-20 focus:outline-offset-0" href="#">
                            <span class="sr-only">Trước</span>
                            <span class="material-symbols-outlined text-xl">chevron_left</span>
                        </a>
                        <a aria-current="page" class="relative z-10 inline-flex items-center bg-primary px-4 py-2 text-sm font-semibold text-neutral-900 focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary" href="#">1</a>
                        <a class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-neutral-700 dark:text-neutral-300 ring-1 ring-inset ring-neutral-300 dark:ring-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-800 focus:z-20 focus:outline-offset-0" href="#">2</a>
                        <a class="relative hidden items-center px-4 py-2 text-sm font-semibold text-neutral-700 dark:text-neutral-300 ring-1 ring-inset ring-neutral-300 dark:ring-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-800 focus:z-20 focus:outline-offset-0 md:inline-flex" href="#">3</a>
                        <span class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-neutral-700 dark:text-neutral-500 ring-1 ring-inset ring-neutral-300 dark:ring-neutral-700">...</span>
                        <a class="relative hidden items-center px-4 py-2 text-sm font-semibold text-neutral-700 dark:text-neutral-300 ring-1 ring-inset ring-neutral-300 dark:ring-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-800 focus:z-20 focus:outline-offset-0 md:inline-flex" href="#">8</a>
                        <a class="relative inline-flex items-center rounded-r-md px-2 py-2 text-neutral-500 dark:text-neutral-400 ring-1 ring-inset ring-neutral-300 dark:ring-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-800 focus:z-20 focus:outline-offset-0" href="#">
                            <span class="sr-only">Sau</span>
                            <span class="material-symbols-outlined text-xl">chevron_right</span>
                        </a>
                    </nav>
                </div>
            </div>
        </main>
        @await Html.PartialAsync("_Footer")
    </div>
    @await Html.PartialAsync("_LoginModal")
    @await Html.PartialAsync("_CommonScripts")
    <script>
        // Sort dropdown functionality
        let currentSortOption = 'default';

        // Helper function to map frontend sort values to backend values
        function mapSortValueToBackend(frontendValue) {
            switch(frontendValue) {
                case 'price-low':
                    return 'price-asc';
                case 'price-high':
                    return 'price-desc';
                case 'default':
                default:
                    return 'newest';
            }
        }

        function toggleSortDropdown(event) {
            if (event) {
                event.stopPropagation();
            }
            const dropdown = document.getElementById('sortDropdownMenu');
            const icon = document.getElementById('sortDropdownIcon');
            
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                dropdown.style.display = 'block';
                icon.textContent = 'expand_less';
            } else {
                dropdown.classList.add('hidden');
                dropdown.style.display = 'none';
                icon.textContent = 'expand_more';
            }
        }

        function selectSortOption(value, text, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            currentSortOption = value;
            document.getElementById('sortSelectedText').textContent = text;
            
            // Update selected state in dropdown
            const options = document.querySelectorAll('.sort-option');
            options.forEach(option => {
                if (option.getAttribute('data-value') === value) {
                    option.classList.remove('text-neutral-800', 'dark:text-white', 'hover:bg-neutral-100', 'dark:hover:bg-neutral-700');
                    option.classList.add('text-white', 'bg-blue-600', 'dark:bg-blue-500', 'hover:bg-blue-700', 'dark:hover:bg-blue-600');
                } else {
                    option.classList.remove('text-white', 'bg-blue-600', 'dark:bg-blue-500', 'hover:bg-blue-700', 'dark:hover:bg-blue-600');
                    option.classList.add('text-neutral-800', 'dark:text-white', 'hover:bg-neutral-100', 'dark:hover:bg-neutral-700');
                }
            });
            
            // Close dropdown
            const dropdown = document.getElementById('sortDropdownMenu');
            const icon = document.getElementById('sortDropdownIcon');
            dropdown.classList.add('hidden');
            dropdown.style.display = 'none';
            icon.textContent = 'expand_more';
            
            // Map frontend values to backend values and apply sorting
            const backendSortValue = mapSortValueToBackend(value);
            applySorting(backendSortValue);
        }

        async function applySorting(sortOption) {
            try {
                const grid = document.getElementById('productsGrid');
                grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-neutral-600 dark:text-[#b9b29d] text-lg">Đang tải...</p></div>';

                // Get current filter parameters
                const brands = Array.from(document.querySelectorAll('input[name="brand"]:checked'))
                    .map(cb => cb.value).join(',');
                const priceRanges = Array.from(document.querySelectorAll('input[name="price"]:checked'))
                    .map(cb => cb.value).join(',');
                const genders = Array.from(document.querySelectorAll('input[name="gender"]:checked'))
                    .map(cb => cb.value).join(',');
                const movements = Array.from(document.querySelectorAll('input[name="movement"]:checked'))
                    .map(cb => cb.value).join(',');
                const strapTypes = Array.from(document.querySelectorAll('input[name="strap"]:checked'))
                    .map(cb => cb.value).join(',');
                const waterResistanceAtms = Array.from(document.querySelectorAll('input[name="waterproof"]:checked'))
                    .map(cb => cb.value).join(',');

                // Get search query from URL
                const urlParams = new URLSearchParams(window.location.search);
                const searchQuery = urlParams.get('searchQuery');

                const params = new URLSearchParams();
                if (brands) params.append('brands', brands);
                if (priceRanges) params.append('priceRanges', priceRanges);
                if (genders) params.append('genders', genders);
                if (movements) params.append('movements', movements);
                if (strapTypes) params.append('strapTypes', strapTypes);
                if (waterResistanceAtms) params.append('waterResistanceAtms', waterResistanceAtms);
                if (searchQuery) params.append('searchQuery', searchQuery);
                params.append('sortBy', sortOption);

                const response = await fetch(`/Product/GetProducts?${params.toString()}`);
                const products = await response.json();

                if (products && products.length > 0) {
                    grid.innerHTML = products.map(product => `
                        <div class="flex flex-col group">
                            <a href="/Product/Details/${product.id}" class="flex flex-col">
                                <div class="overflow-hidden rounded-lg bg-neutral-200/50 dark:bg-[#393528]/50">
                                    <img alt="${product.name}" 
                                         class="w-full h-80 object-cover group-hover:scale-105 transition-transform duration-300" 
                                         src="${product.imageUrl || 'https://images.unsplash.com/photo-1523275335684-37898b6baf30'}" />
                                </div>
                                <div class="flex flex-col gap-1 mt-4">
                                    <h3 class="text-neutral-800 dark:text-white text-lg font-bold">${product.brand.toUpperCase()}</h3>
                                    <p class="text-neutral-600 dark:text-[#b9b29d] text-sm">${product.name}</p>
                                    <p class="text-neutral-800 dark:text-white font-semibold mt-1">${product.price.toLocaleString('vi-VN')} ₫</p>
                                </div>
                            </a>
                            <div class="flex gap-2 mt-3">
                                <button onclick="buyNow(${product.id}, event)" class="flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-primary hover:bg-primary/90 text-neutral-900 font-semibold transition-colors shadow-sm">
                                    <span class="material-symbols-outlined text-base">shopping_bag</span>
                                    <span class="text-sm">Mua ngay</span>
                                </button>
                                <button onclick="addToCart(${product.id}, event)" class="flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-neutral-700 dark:bg-neutral-600 hover:bg-neutral-800 dark:hover:bg-neutral-700 text-white font-medium transition-colors">
                                    <span class="material-symbols-outlined text-base">shopping_cart</span>
                                    <span class="text-sm">Giỏ hàng</span>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-neutral-600 dark:text-[#b9b29d] text-lg">Không tìm thấy sản phẩm nào</p></div>';
                }
            } catch (error) {
                console.error('Error sorting products:', error);
                const grid = document.getElementById('productsGrid');
                grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-red-600 dark:text-red-400 text-lg">Có lỗi xảy ra khi sắp xếp sản phẩm</p></div>';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('sortDropdownMenu');
                const button = document.getElementById('sortDropdownBtn');
                
                if (!button.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.classList.add('hidden');
                    dropdown.style.display = 'none';
                    document.getElementById('sortDropdownIcon').textContent = 'expand_more';
                }
            });
        });

        function toggleFilter(button) {
            const filterSection = button.closest('.filter-section');
            const content = filterSection.querySelector('.filter-content');
            const icon = button.querySelector('.filter-icon');

            if (content.classList.contains('hidden')) {
                // Open this filter
                content.classList.remove('hidden');
                icon.textContent = 'expand_less';
                button.classList.add('bg-primary/20', 'dark:bg-[#393528]');
            } else {
                // Close this filter
                content.classList.add('hidden');
                icon.textContent = 'expand_more';
                button.classList.remove('bg-primary/20', 'dark:bg-[#393528]');
            }
        }

        // Initialize filters from URL params on page load
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check brands from URL
            const brandsParam = urlParams.get('brands');
            if (brandsParam) {
                const brandValues = brandsParam.toLowerCase().split(',');
                brandValues.forEach(brand => {
                    const checkbox = document.querySelector(`input[name="brand"][value="${brand.trim()}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        // Open the brand filter section
                        const brandSection = checkbox.closest('.filter-section');
                        if (brandSection) {
                            const content = brandSection.querySelector('.filter-content');
                            const button = brandSection.querySelector('button');
                            const icon = button.querySelector('.filter-icon');
                            content.classList.remove('hidden');
                            icon.textContent = 'expand_less';
                            button.classList.add('bg-primary/20', 'dark:bg-[#393528]');
                        }
                    }
                });
            }
            
            // Check genders from URL
            const gendersParam = urlParams.get('genders');
            if (gendersParam) {
                const genderValues = gendersParam.toLowerCase().split(',');
                genderValues.forEach(gender => {
                    const checkbox = document.querySelector(`input[name="gender"][value="${gender.trim()}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        // Open the gender filter section
                        const genderSection = checkbox.closest('.filter-section');
                        if (genderSection) {
                            const content = genderSection.querySelector('.filter-content');
                            const button = genderSection.querySelector('button');
                            const icon = button.querySelector('.filter-icon');
                            content.classList.remove('hidden');
                            icon.textContent = 'expand_less';
                            button.classList.add('bg-primary/20', 'dark:bg-[#393528]');
                        }
                    }
                });
            }
            
            // Check price ranges from URL
            const priceRangesParam = urlParams.get('priceRanges');
            if (priceRangesParam) {
                const priceValues = priceRangesParam.split(',');
                priceValues.forEach(price => {
                    const checkbox = document.querySelector(`input[name="price"][value="${price.trim()}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        // Open the price filter section
                        const priceSection = checkbox.closest('.filter-section');
                        if (priceSection) {
                            const content = priceSection.querySelector('.filter-content');
                            const button = priceSection.querySelector('button');
                            const icon = button.querySelector('.filter-icon');
                            content.classList.remove('hidden');
                            icon.textContent = 'expand_less';
                            button.classList.add('bg-primary/20', 'dark:bg-[#393528]');
                        }
                    }
                });
            }
        });

        // Handle checkbox single selection per filter group
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('click', function(e) {
                    const clickedCheckbox = this;
                    const checkboxName = clickedCheckbox.getAttribute('name');
                    
                    // If clicking on an already checked checkbox, allow it to uncheck
                    if (clickedCheckbox.checked) {
                        // Uncheck all other checkboxes with the same name
                        checkboxes.forEach(cb => {
                            if (cb.getAttribute('name') === checkboxName && cb !== clickedCheckbox) {
                                cb.checked = false;
                            }
                        });
                    }
                });
            });
        });

        // Filter logic
        const filterCheckboxes = document.querySelectorAll('input[type="checkbox"]');
        let filterTimeout;

        filterCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                // Debounce filter requests
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    applyFilters();
                }, 300);
            });
        });

        async function applyFilters() {
            // Collect selected filters
            const brands = Array.from(document.querySelectorAll('input[name="brand"]:checked'))
                .map(cb => cb.value).join(',');
            
            const priceRanges = Array.from(document.querySelectorAll('input[name="price"]:checked'))
                .map(cb => cb.value).join(',');
            
            const genders = Array.from(document.querySelectorAll('input[name="gender"]:checked'))
                .map(cb => cb.value).join(',');
            
            const movements = Array.from(document.querySelectorAll('input[name="movement"]:checked'))
                .map(cb => cb.value).join(',');
            
            const strapTypes = Array.from(document.querySelectorAll('input[name="strap"]:checked'))
                .map(cb => cb.value).join(',');
            
            const waterResistanceAtms = Array.from(document.querySelectorAll('input[name="waterproof"]:checked'))
                .map(cb => cb.value).join(',');

            // Get search query from URL
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('searchQuery');

            // Build query string
            const params = new URLSearchParams();
            if (brands) params.append('brands', brands);
            if (priceRanges) params.append('priceRanges', priceRanges);
            if (genders) params.append('genders', genders);
            if (movements) params.append('movements', movements);
            if (strapTypes) params.append('strapTypes', strapTypes);
            if (waterResistanceAtms) params.append('waterResistanceAtms', waterResistanceAtms);
            if (searchQuery) params.append('searchQuery', searchQuery);
            if (currentSortOption) {
                const backendSortValue = mapSortValueToBackend(currentSortOption);
                params.append('sortBy', backendSortValue);
            }

            try {
                // Show loading state
                const grid = document.getElementById('productsGrid');
                grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-neutral-600 dark:text-[#b9b29d] text-lg">Đang tải...</p></div>';

                // Fetch filtered products
                const response = await fetch(`/Product/GetProducts?${params.toString()}`);
                const products = await response.json();

                // Update grid
                if (products && products.length > 0) {
                    grid.innerHTML = products.map(product => `
                        <div class="flex flex-col group">
                            <a href="/Product/Details/${product.id}" class="flex flex-col">
                                <div class="overflow-hidden rounded-lg bg-neutral-200/50 dark:bg-[#393528]/50">
                                    <img alt="${product.name}" 
                                         class="w-full h-80 object-cover group-hover:scale-105 transition-transform duration-300" 
                                         src="${product.imageUrl || 'https://images.unsplash.com/photo-1523275335684-37898b6baf30'}" />
                                </div>
                                <div class="flex flex-col gap-1 mt-4">
                                    <h3 class="text-neutral-800 dark:text-white text-lg font-bold">${product.brand.toUpperCase()}</h3>
                                    <p class="text-neutral-600 dark:text-[#b9b29d] text-sm">${product.name}</p>
                                    <p class="text-neutral-800 dark:text-white font-semibold mt-1">${product.price.toLocaleString('vi-VN')} ₫</p>
                                </div>
                            </a>
                            <div class="flex gap-2 mt-3">
                                <button onclick="buyNow(${product.id}, event)" class="flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-primary hover:bg-primary/90 text-neutral-900 font-semibold transition-colors shadow-sm">
                                    <span class="material-symbols-outlined text-base">shopping_bag</span>
                                    <span class="text-sm">Mua ngay</span>
                                </button>
                                <button onclick="addToCart(${product.id}, event)" class="flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-neutral-700 dark:bg-neutral-600 hover:bg-neutral-800 dark:hover:bg-neutral-700 text-white font-medium transition-colors">
                                    <span class="material-symbols-outlined text-base">shopping_cart</span>
                                    <span class="text-sm">Giỏ hàng</span>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-neutral-600 dark:text-[#b9b29d] text-lg">Không tìm thấy sản phẩm nào</p></div>';
                }
            } catch (error) {
                console.error('Error fetching products:', error);
                const grid = document.getElementById('productsGrid');
                grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-red-600 dark:text-red-400 text-lg">Có lỗi xảy ra khi tải sản phẩm</p></div>';
            }
        }

        // Clear all filters
        document.getElementById('clearAllFilters').addEventListener('click', function() {
            // Uncheck all checkboxes
            const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
            allCheckboxes.forEach(cb => cb.checked = false);
            
            // Reload page to show all products
            window.location.href = '/Product';
        });

        // Check if user is logged in
        function isUserLoggedIn() {
            // Check if user info exists in header (sign out button indicates logged in)
            return document.querySelector('form[asp-controller="Account"][asp-action="Logout"]') !== null ||
                   document.querySelector('a[asp-controller="Admin"]') !== null ||
                   @(SignInManager.IsSignedIn(User) ? "true" : "false");
        }

        // Show notification message
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-24 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 
                'bg-primary'
            } text-white font-medium`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined">${
                        type === 'error' ? 'error' : 
                        type === 'success' ? 'check_circle' : 
                        'info'
                    }</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
                notification.classList.add('translate-x-0');
            }, 10);
            
            // Animate out and remove
            setTimeout(() => {
                notification.classList.remove('translate-x-0');
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Buy now function
        function buyNow(productId, event) {
            event.preventDefault();
            event.stopPropagation();
            
            // Check if user is logged in
            if (!isUserLoggedIn()) {
                showNotification('Vui lòng đăng nhập để mua sản phẩm', 'error');
                setTimeout(() => {
                    openLoginModal();
                }, 500);
                return;
            }
            
            // TODO: Implement buy now logic
            // This should add to cart and redirect to checkout
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<span class="material-symbols-outlined text-base">check</span><span class="text-sm">Đang xử lý...</span>';
            
            // Simulate processing
            setTimeout(() => {
                // Redirect to cart or checkout page
                // window.location.href = '/Cart/Checkout';
                
                button.disabled = false;
                button.innerHTML = originalText;
            }, 1000);
        }

        // Add to cart function
        function addToCart(productId, event) {
            event.preventDefault();
            event.stopPropagation();
            
            // Check if user is logged in
            if (!isUserLoggedIn()) {
                showNotification('Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng', 'error');
                setTimeout(() => {
                    openLoginModal();
                }, 500);
                return;
            }
            
            // TODO: Implement add to cart logic
            // This can be an AJAX call to add the product to cart
            // For now, just show a notification
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<span class="material-symbols-outlined text-base">check</span><span class="text-sm">Đã thêm</span>';
            button.classList.remove('bg-neutral-700', 'dark:bg-neutral-600', 'hover:bg-neutral-800', 'dark:hover:bg-neutral-700');
            button.classList.add('bg-green-500', 'hover:bg-green-600');
            
            // Reset button after 2 seconds
            setTimeout(() => {
                button.disabled = false;
                button.innerHTML = originalText;
                button.classList.remove('bg-green-500', 'hover:bg-green-600');
                button.classList.add('bg-neutral-700', 'dark:bg-neutral-600', 'hover:bg-neutral-800', 'dark:hover:bg-neutral-700');
            }, 2000);
            
            // You can add actual cart functionality here:
            // fetch('/Cart/Add', { method: 'POST', body: JSON.stringify({ productId: productId }), ... })
        }
    </script>
</body>
</html>

