@using Microsoft.AspNetCore.Identity
@using RomaWatches.Models
@inject SignInManager<ApplicationUser> SignInManager
<script>
    // Lưu trạng thái đăng nhập từ server để sử dụng ở client-side
    const userIsLoggedIn = @(SignInManager.IsSignedIn(User) ? "true" : "false");
    
    // Hàm mở modal đăng nhập - được sử dụng chung cho tất cả các trang
    function openLoginModal() {
        const modal = document.getElementById('loginModal');
        const modalContent = document.getElementById('modalContent');
        if (modal && modalContent) {
            modal.classList.remove('hidden');
            // Hiệu ứng trượt vào
            modalContent.classList.remove('translate-x-full');
            modalContent.classList.add('translate-x-0');
            // Ngăn cuộn trang khi modal mở
            document.body.style.overflow = 'hidden';
        }
    }

    // Hàm đóng modal đăng nhập
    function closeLoginModal() {
        const modal = document.getElementById('loginModal');
        const modalContent = document.getElementById('modalContent');
        if (modal && modalContent) {
            // Hiệu ứng trượt ra
            modalContent.classList.remove('translate-x-0');
            modalContent.classList.add('translate-x-full');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300); // Đợi hiệu ứng hoàn tất
        }
    }

    // Bật/tắt thanh tìm kiếm
    function toggleSearch() {
        const searchContainer = document.getElementById('searchContainer');
        const searchInput = document.getElementById('searchInput');
        
        if (searchContainer && searchInput) {
            if (searchContainer.classList.contains('hidden')) {
                searchContainer.classList.remove('hidden');
                searchInput.focus();
            } else {
                searchContainer.classList.add('hidden');
                searchInput.value = '';
            }
        }
    }

    // Xử lý khi submit form tìm kiếm
    function handleSearch(event) {
        event.preventDefault();
        const searchInput = document.getElementById('searchInput');
        
        if (searchInput && searchInput.value.trim()) {
            const searchQuery = encodeURIComponent(searchInput.value.trim());
            // Chuyển hướng đến trang sản phẩm với từ khóa tìm kiếm
            window.location.href = `/Product?searchQuery=${searchQuery}`;
        }
    }

    // Đóng thanh tìm kiếm khi click ra ngoài
    document.addEventListener('DOMContentLoaded', function() {
        document.addEventListener('click', function(event) {
            const searchContainer = document.getElementById('searchContainer');
            const searchButton = event.target.closest('button[onclick="toggleSearch()"]');
            const searchForm = event.target.closest('#searchForm');
            
            if (searchContainer && !searchContainer.classList.contains('hidden')) {
                if (!searchButton && !searchForm && !searchContainer.contains(event.target)) {
                    searchContainer.classList.add('hidden');
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                }
            }
        });

        // Tải số lượng giỏ hàng khi trang được tải
        loadCartCount();
    });

    // Hàm tải số lượng giỏ hàng từ server
    function loadCartCount() {
        fetch('/Cart/GetCartCount')
            .then(response => response.json())
            .then(data => {
                updateCartCountInHeader(data.count || 0);
            })
            .catch(error => {
                console.error('Error loading cart count:', error);
            });
    }

    // Hàm cập nhật hiển thị số lượng giỏ hàng trên header
    function updateCartCountInHeader(count) {
        const cartBadge = document.querySelector('header .shopping-bag-badge');
        if (cartBadge) {
            cartBadge.textContent = count;
            if (count === 0) {
                cartBadge.style.display = 'none';
            } else {
                cartBadge.style.display = 'flex';
            }
        }
    }

    // Kiểm tra xem người dùng đã đăng nhập chưa
    function isUserLoggedIn() {
        // Kiểm tra giá trị từ server trước (đáng tin cậy nhất)
        if (typeof userIsLoggedIn !== 'undefined' && userIsLoggedIn === true) {
            return true;
        }
        // Fallback: Kiểm tra thông tin user trên header hoặc nút đăng xuất
        return document.querySelector('form[asp-controller="Account"][asp-action="Logout"]') !== null ||
               document.querySelector('a[asp-controller="Admin"]') !== null;
    }

    // Hiển thị thông báo (Toast notification)
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-24 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full ${
            type === 'error' ? 'bg-red-500' : 
            type === 'success' ? 'bg-green-500' : 
            'bg-primary'
        } text-white font-medium`;
        notification.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined">${
                    type === 'error' ? 'error' : 
                    type === 'success' ? 'check_circle' : 
                    'info'
                }</span>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Hiệu ứng trượt vào
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
            notification.classList.add('translate-x-0');
        }, 10);
        
        // Hiệu ứng trượt ra và xóa
        setTimeout(() => {
            notification.classList.remove('translate-x-0');
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }

    // Xử lý click vào giỏ hàng - kiểm tra đăng nhập trước khi điều hướng
    function handleCartClick(event) {
        event.preventDefault();
        event.stopPropagation();
        
        if (!isUserLoggedIn()) {
            showNotification('Vui lòng đăng nhập để xem giỏ hàng', 'error');
            setTimeout(() => {
                if (typeof openLoginModal === 'function') {
                    openLoginModal();
                }
            }, 500);
            return;
        }
        
        // Nếu đã đăng nhập, chuyển hướng đến trang giỏ hàng
        window.location.href = '/Cart';
    }
</script>
